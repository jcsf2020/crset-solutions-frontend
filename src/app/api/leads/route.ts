export const runtime='nodejs';import{NextResponse}from'next/server';const NOTION_VERSION='2022-06-28';async function listFromNotion(){const key=process.env.NOTION_API_KEY;const db=process.env.NOTION_DATABASE_ID;if(!key||!db)return null;const r=await fetch(`https://api.notion.com/v1/databases/${db}/query`,{method:'POST',headers:{Authorization:`Bearer ${key}`,'Notion-Version':NOTION_VERSION,'Content-Type':'application/json'},body:JSON.stringify({page_size:50,sorts:[{timestamp:'created_time',direction:'descending'}]}),cache:'no-store'});if(!r.ok){const text=await r.text().catch(()=>'' );return{error:`notion_${r.status}`,detail:text,items:[],total:0}}const j=await r.json();const items=(j.results||[]).map((p:any)=>{const props=p.properties||{};const when=props['Data/Hora']?.date?.start??p.created_time;const name=(props['Nome']?.title?.[0]?.plain_text)||(props['Name']?.title?.[0]?.plain_text)||'';const email=(props['Email']?.email)||(props['E-mail']?.email)||'';const utm=(props['Origem/UTM']?.rich_text?.[0]?.plain_text)||(props['UTM']?.rich_text?.[0]?.plain_text)||(props['Origem']?.rich_text?.[0]?.plain_text)||(props['Source']?.rich_text?.[0]?.plain_text)||'';const score=(props['Score']?.number)??(props['Pontuação']?.number)??0;const ip=(props['IP']?.rich_text?.[0]?.plain_text)||'';return{when,name,email,utm,score,ip}});return{items,total:items.length}}export async function GET(){try{const data=await listFromNotion();if(data===null){const items=[{when:new Date().toISOString(),name:'E2E',email:'crsetsolutions@gmail.com',utm:'utm_source=test',score:0.7,ip:'127.0.0.1'}];return NextResponse.json({items,total:items.length,note:'placeholder_envs_missing'})}return NextResponse.json(data)}catch(e:any){return NextResponse.json({items:[],total:0,error:'fetch_failed',detail:String(e?.message||e)})}}
