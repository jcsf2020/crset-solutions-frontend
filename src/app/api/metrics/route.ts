export const runtime='nodejs';import{NextResponse}from'next/server';const V='2022-06-28';async function fetchAll(){const key=process.env.NOTION_API_KEY,db=process.env.NOTION_DATABASE_ID;if(!key||!db)return null;const headers={Authorization:`Bearer ${key}`,'Notion-Version':V,'Content-Type':'application/json'} as any;let has=true,c=null,results:any[]=[];for(let i=0;i<5&&has;i++){const body:any={page_size:100,sorts:[{timestamp:'created_time',direction:'descending'}]};if(c)body.start_cursor=c;const r=await fetch(`https://api.notion.com/v1/databases/${db}/query`,{method:'POST',headers,body:JSON.stringify(body),cache:'no-store'});if(!r.ok)return{error:`notion_${r.status}`,detail:await r.text().catch(()=>''),items:[],total:0};const j=await r.json();results.push(...(j.results||[]));has=j.has_more;c=j.next_cursor}return{results}}export async function GET(){try{const res:any=await fetchAll();if(res===null)return NextResponse.json({error:'no_env'});if(res.error)return NextResponse.json(res);const results=res.results||[];const now=Date.now(),D=(ms:number)=>new Date(ms).toISOString().slice(0,10);const items=results.map((p:any)=>{const pr=p.properties||{};const when=pr['Data/Hora']?.date?.start||p.created_time;const utm=pr['Origem/UTM']?.rich_text?.[0]?.plain_text||pr['UTM']?.rich_text?.[0]?.plain_text||pr['Origem']?.rich_text?.[0]?.plain_text||pr['Source']?.rich_text?.[0]?.plain_text||'';return{when,utm}});const total=items.length,last24h=items.filter(i=>now-new Date(i.when).getTime()<=24*3600*1000).length,last7d=items.filter(i=>now-new Date(i.when).getTime()<=7*24*3600*1000).length;const byUtm:Record<string,number>={};for(const it of items){const k=(it.utm||'').trim()||'(none)';byUtm[k]=(byUtm[k]||0)+1}const top_utm=Object.entries(byUtm).sort((a,b)=>b[1]-a[1]).slice(0,5);const by_day_raw:Record<string,number>={};for(const it of items){const k=D(new Date(it.when).getTime());by_day_raw[k]=(by_day_raw[k]||0)+1}const days=Array.from({length:14},(_,i)=>D(now-(13-i)*24*3600*1000));const by_day=days.map(d=>({date:d,count:by_day_raw[d]||0}));return NextResponse.json({total,last24h,last7d,top_utm,by_day})}catch(e:any){return NextResponse.json({error:'metrics_failed',detail:String(e?.message||e)},{status:500})}}
