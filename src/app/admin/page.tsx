'use client';import{useEffect,useState}from'react';const KEY=process.env.NEXT_PUBLIC_ADMIN_KEY||'devonly';type Lead={when:string;name:string;email:string;utm:string;score:number;ip:string};const fmt=(s:string)=>{try{return new Date(s).toLocaleString('pt-PT',{timeZone:'Europe/Lisbon'})}catch{return s}};const toCSV=(rows:Lead[])=>['Data/Hora,Nome,Email,UTM,Score,IP',...rows.map(r=>[r.when,r.name,r.email,r.utm,r.score,r.ip].map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(','))].join('\n');export default function AdminPage(){const[ok,setOk]=useState(false);const[v,setV]=useState('');const[data,setData]=useState<Lead[]>([]);const[loading,setLoading]=useState(false);const load=()=>{setLoading(true);fetch('/api/leads',{cache:'no-store'}).then(r=>r.json()).then(j=>setData(j.items||[])).catch(()=>setData([])).finally(()=>setLoading(false))};useEffect(()=>{if(typeof window!=='undefined'&&localStorage.getItem('ADMIN_OK')==='1')setOk(true)},[]);useEffect(()=>{if(ok)load()},[ok]);if(!ok){return(<main style={{padding:'24px',fontFamily:'system-ui',maxWidth:520,margin:'40px auto'}}><h1 style={{fontSize:22,fontWeight:600,marginBottom:12}}>Admin</h1><input type="password" placeholder="Pass" value={v} onChange={e=>setV(e.target.value)} style={{width:'100%',padding:'10px',border:'1px solid #ddd',borderRadius:8,marginBottom:12}}/><button onClick={()=>{if(v===KEY){localStorage.setItem('ADMIN_OK','1');setOk(true)}else alert('Wrong pass')}} style={{width:'100%',padding:'10px',borderRadius:12,border:'1px solid #ddd'}}>Entrar</button><p style={{opacity:.6,fontSize:12,marginTop:8}}>Gate temporário • NEXT_PUBLIC_ADMIN_KEY.</p></main>)}const thBase={padding:'8px 10px',textAlign:'left' as const};const tdBase={padding:'8px 10px'};return(<main style={{padding:'24px',fontFamily:'system-ui'}}><div style={{display:'flex',gap:12,alignItems:'center',marginBottom:12}}><h1 style={{fontSize:22,fontWeight:600,margin:0}}>Leads</h1><span style={{opacity:.7}}>Total: {data.length}</span><button onClick={load} disabled={loading} style={{padding:'6px 10px',borderRadius:10,border:'1px solid #ddd'}}>{loading?'A atualizar…':'Atualizar'}</button><button onClick={()=>{const blob=new Blob([toCSV(data)],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='leads.csv';a.click();URL.revokeObjectURL(url)}} style={{padding:'6px 10px',borderRadius:10,border:'1px solid #ddd'}}>Export CSV</button><button onClick={()=>{localStorage.removeItem('ADMIN_OK');location.reload()}} style={{marginLeft:'auto',padding:'6px 10px',borderRadius:10,border:'1px solid #ddd'}}>Sair</button></div><div style={{overflow:'auto',border:'1px solid #eee',borderRadius:12}}><table style={{width:'100%',fontSize:13,borderCollapse:'collapse'}}><thead><tr style={{background:'#fafafa'}}><th style={{...thBase,whiteSpace:'nowrap' as const}}>Data/Hora</th><th style={{...thBase}}>Nome</th><th style={{...thBase}}>Email</th><th style={{...thBase}}>UTM</th><th style={{...thBase}}>Score</th><th style={{...thBase}}>IP</th></tr></thead><tbody>{data.length?data.map((r,i)=>(<tr key={i} style={{borderTop:'1px solid #eee'}}><td style={{...tdBase,whiteSpace:'nowrap'}} title={r.when}>{fmt(r.when)}</td><td style={{...tdBase}}>{r.name||'—'}</td><td style={{...tdBase}}><button onClick={()=>{navigator.clipboard?.writeText(r.email).catch(()=>{})}} title="Copiar" style={{all:'unset',cursor:'pointer',textDecoration:'underline'}}>{r.email||'—'}</button></td><td style={{...tdBase}}>{r.utm||'—'}</td><td style={{...tdBase}}>{r.score??'—'}</td><td style={{...tdBase}}>{r.ip||'—'}</td></tr>)):(<tr><td colSpan={6} style={{padding:'10px',opacity:.6}}>Sem dados.</td></tr>)}</tbody></table></div></main>)}
